### 消息队列如何解决消息丢失问题？

1、生产消息阶段：Producer->消息队列Broker端

- 请求确认机制：发送消息将消息发送到Broker，接收到后会返回客户端一个确认响应，表明消息收到。确保生产阶段消息不丢失。如果长时间没有响应则会重试。

2、存储消息阶段：消息队列Broker端存储，如果有集群则会复制到其他结点。

- 配置Broker：备份消息，防止Broker宕机使得消息丢失。配置刷盘和复制相关的参数，消息写入到多个副本磁盘，确保不会因为Broker宕机或者磁盘损坏丢失。
  - RocketMQ是通过固定配置，主节点宕机，生产者不能再生产消息，消费者会切换到从结点消费，即使主节点有消息没有复制到从节点，但是已经持久化到磁盘了，主节点恢复以后仍然可以继续复制到从结点。牺牲可用性，换取性能和数据一致性。Dledger复制是通过选举的时候进行新结点选举。
  - Kafka是按照分区划分，每个分区的几个副本构成小的复制集群，Broker只是分区的容器，Broker不分主从。使用Zookeeper来监控分区的多个结点，发现分区主节点宕机，会选举新的主节点。

3、消费阶段

- 确认机制(类似生产阶段)：客户端从Broker拉取消息，成功消费以后会发送消费确认，如果Broker没有收到消费确认响应，下次消费者拉取的时候还会发送同一条消息。（不要在收到消息的时候就立即发送消费确认，应该等待消费业务逻辑完成以后再发送消费确认。）