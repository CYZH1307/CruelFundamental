### Java: JVM内存溢出排查? 内存泄露怎么分析?怎么知道整条内存泄露的链路?

#### 内存溢出

java.lang.OutOfMemoryError：是指程序在申请内存时，没有足够的内存空间供其使用，出现OutOfMemoryError。产生原因产生该错误的原因主要包括：

- JVM内存过小。
- 程序不严密，产生了过多的垃圾。

一般情况下，在程序上的体现为：

- 内存中加载的数据量过于庞大，如一次从数据库取出过多数据。
- 集合类中有对对象的引用，使用完后未清空，使得JVM不能回收。
- 代码中存在死循环或循环产生过多重复的对象实体。
- 使用的第三方软件中的BUG。
- 启动参数内存值设定的过小。



#### 内存泄露

​		Memory Leak是指程序在申请内存后，无法释放已申请的内存空间，一次内存泄露危害可以忽略，但内存泄露堆积后果很严重，无论多少内存，迟早会被占光。在Java中，内存泄漏就是存在一些被分配的对象，这些对象有下面两个特点：

- 首先，这些对象是可达的，即在有向图中，存在通路可以与其相连；
- 其次，这些对象是无用的，即程序以后不会再使用这些对象。

​        如果对象满足这两个条件，这些对象就可以判定为Java中的内存泄漏，这些对象不会被GC所回收，然而它却占用内存。关于内存泄露的处理页就是提高程序的健壮型，因为内存泄露是纯代码层面的问题。



#### **内存溢出和内存泄露的联系**

内存泄露会最终会导致内存溢出。

相同点：都会导致应用程序运行出现问题，性能下降或挂起。

不同点：内存泄露是导致内存溢出的原因之一，内存泄露积累起来将导致内存溢出。内存泄露可以通过完善代码来避免，内存溢出可以通过调整配置来减少发生频率，但无法彻底避免。





#### 如何排查

##### 确定频繁Full GC现象

###### 【jps】虚拟机进程状况工具

- 使用`jps`找出这个进程在本地虚拟机的唯一ID，因为在后面的排查过程中都是需要这个LVMID来确定要监控的是哪一个虚拟机进程。

- 命令格式为：

  ```
  jps [ options ] [ hostid ]
  ```

  - 常用jps -l。

###### 【jstat】虚拟机统计信息监视工具

- 查看已使用空间站总空间的百分比.

- 命令格式：`jstat [ option vmid [interval[s|ms] [count]] ]`

  - 如

    ```
    jstat -gcutil 20954 1000
    ```

    - gcutil指：已使用空间站总空间的百分比。
    - 20954指：pid
    - 1000指：每1000毫秒查询一次，一直查。



##### 找出导致频繁Full GC的原因

分析方法通常有两种：

- 把堆dump下来再用MAT等工具进行分析，但dump堆要花较长的时间，并且文件巨大，再从服务器上拖回本地导入工具，这个过程有些折腾，不到万不得已最好别这么干。
- 更轻量级的在线分析，使用“Java内存影像工具：jmap”生成堆转储快照（一般称为headdump或dump文件）。

###### 【jmap】使用

- jmap命令格式：`jmap [ option ] vmid`
- 使用命令如下：`jmap -histo:live 20954`

- 如果上面一步还无法定位到关键信息，那么需要拿到**heap dump**，生成离线文件，做进一步分析，
- 使用命令如：`jmap -dump:live,format=b,file=heap.hprof 3514`



#### 怎么知道整条内存泄露的链路?

可以使用MAT插件或上文提到的排查命令，进行对内存泄露对象的定位。找到内存泄露的对象，根据现行和对应的线程的堆栈信息，定位内存泄露的位置。