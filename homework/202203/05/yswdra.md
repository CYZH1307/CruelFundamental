### C++: 简述 mechanism of new

------

首先，我们最常用的new功能是分两大步走的：先调用底层malloc函数在堆上分配内存，然后调用其构造函数。具体流程如下

1. malloc在堆上分配空间，**若传入size为0，则默认分配1字节的空间**（每一个类的实例都要有自己的地址，即使类为空）
2. 检查内存分配成功与否
   1. 分配不成功，跳3
   2. 分配成功，    跳4
3. 执行空间分配失败的处理函数
   1. 处理成功，  跳1
   2. 处理不成功，抛出异常退出
4. 调用构造函数（这部分代码由编译器生成，放在此处调用的逻辑只是本人猜测）
5. 返回空间指针

这里要注意空间分配失败的处理函数可以自己重载，例如可以执行一些释放空间的操作使得空间分配成功的概率更大。

既然一般的new的流程是分两步走的，那我们自然也可以提出后一步操作单独使用，也就是直接对已分配的空间调用构造函数，这里的new操作叫做 placement new，这里需要注意的事，**既然你使用了placement new操作，那么自然也需要调用对应的placement delete来操作**，除非你清楚你不这么做的后果。

还有一个需要注意的是，既然new的流程分两大步，如果构造函数中有抛出异常的操作，那么就会造成分配的空间地址无法正常返回的情况，大概率造成内存泄漏的问题（可能编译器帮你优化了这个问题），**因此最好不要让构造函数抛出异常，同上，除非你清楚你在构造函数中抛出异常所带来的后果**。

