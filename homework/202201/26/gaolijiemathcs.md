# 20220126 什么是三级封锁协议？

1、两种锁：

（1）共享锁 S锁(shared)：事务可读不可写。(其他事务可以同时添加S锁，不能添加X锁)

规则：事务对数据A上了S锁，那么不允许其他事务加X锁，但可以添加S锁。

（2）排他锁 X锁(exclusive)：事务可读可写。（其他事务不可以同时添加任何锁）

规则：事务对数据A上了X锁，那么不允许其他事务加X锁或S锁。

总之就是

```
一个事务对数据A加S锁，另一个事务对数据A，不能加X锁，可以加S锁。
一个书屋对数据A加X锁，另一个事务对数据A，不能加X锁，也不能加S锁。
X锁不能与其他任何锁同时存在，但S锁与X锁可以同时存在。
```



2、三级锁协议

一级封锁协议：

```
内容：事务T修改数据R之前先加X锁，直到事务结束时释放。(事务结束包含正常commit和非正常rollback)
作用：防止丢失修改，保证事务T可恢复。
局限：读数据不修改，不加锁，所以不能保证可重复读和不读脏数据。
```

二级封锁协议：

```
内容：一级封锁协议加上事务T在读取数据R之前必须先对其加上S锁，读完操作完之后即可释放S锁。
作用：二级封锁协议可以防止丢失修改和读脏数据
局限：使用二级封锁协议不能解决不可重复读问题
```

三级封锁协议：

```
内容：一级封锁协议加上事务T在读取数据R之前必须先对其加S锁，直到事务结束才释放。
作用：三级封锁协议可以防止丢失修改、读脏数据和不可重复读问题
```



3、小结

（1）锁基本类型：排他锁(X锁、写锁)、共享锁（S锁、读锁）

（2）封锁协议：一级、二级、三级封锁协议

![image-20220126134753187](https://raw.githubusercontent.com/gaolijiemathcs/image-hosting/master/image-20220126134753187.png)

一级封锁协议：加X锁，不能保证可重复读和不读脏数据。

二级封锁协议：一级基础上加S锁，读完释放S锁，避免读脏数据，不能保证可重复读。

三级封锁协议：一级基础上加S锁，事务结束以后才释放S锁，可以防止丢失修改，读脏数据，重复读问题。

- 主要区别：什么时候操作需要申请加锁和释放锁时间。（持锁时间）
- 不同的封锁协议使事务达到的一致性级别不同：封锁协议级别越高，一致性程度越高。