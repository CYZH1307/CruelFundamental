# 消息队列如何解决消息丢失问题？

### 问题的产生

pub端是不会出现消息丢失的，一般消息丢失产生在分布式系统的broker或sub端中。broker丢失的原因一般是主备不同步或者持久化失败，sub端丢失的原因一般是消费动作未完成就进程终止。

### 解决思路

在pub端，给每个发出的消息都指定一个全局唯一的id，或者设定一个连续递增的版本号，然后在sub做对应的版本校验。校验不通过则要求重发消息并重新同步。

### 备选方案

全局唯一的id生成的实现有数据库自增主键、UUID、Redis，Twitter-Snowflake 算法等方案，优缺点如下：

    1.数据库自增主键：ID不会重复。但数据库宕机则失效，数据库主备同步也是难题。
    2.UUID：通过多位随机计算以达到工程上的ID不重复。但数据过长，也存在信息安全问题。
    3.Redis原子操作：性能优于一般数据库的ID生成法。但配置Redis会引入额外工作量，且ID在Redis持久化模式下会重复。
    4.Snowflake：不依赖第三方系统从而稳定性高，bit分配灵活，使用时间戳从而ID在理论上不会重复，且时间戳在高位可使所有时间戳分布符合时间局部性。但强依赖本地时钟，如果出现时钟回拨则会导致ID重复。
