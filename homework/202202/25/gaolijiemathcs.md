## a、b两台服务器怎么判断是否能连通，为什么能用ping和traceroute

### 通过ICMP协议测试网络的连通性

IP协议不提供可靠传输，如果丢包，IP协议无法通知传输层是否丢包和丢包的原因。因此需要ICMP来判断是否能够连通，ICMP主要功能：确认IP包是否达到目标地址，并且通知在发送过程中IP包丢失的原图。

ICMP(Internet Control Message Protocol)Internet控制报文，是TCP/IP协议族的一个子协议，用于在IP主机、路由器之间传递控制消息。控制消息包括，网络不通、主机是否可达、路由器是否可用的网络本身的消息，这些控制消息不传输具体的用户数据。用于主机或者路由报告差错异常相关的情报，和IP协议同处网络层，但是ICMP会使用IP最终由IP来传输协议信息。

报文分为：差错报告报文和询问报文。

常见应用：ping用于测试网络的可达性，tracerounte用于查询路由路径。



### ping

作用：能够验证网络的连通性，统计响应时间和TTL(Time to live,生存周期)

原理：A主机 ping B的ip

（1）A主机构建ICMP请求数据包，ICMP协议将数据包与目标IP信息交给IP层协议

（2）将源ip地址、目标IP，控制信息构建IP数据包，IP数据包构建完毕加上MAC地址，通过ARP映射表找出目标IP对应的MAC地址和本机MAC，交给数据链路层，组成数据组，发送数据帧。

（3）主机B收到数据帧，拆包检查目标MAC，目标IP地址，转给ICMP协议处理，构建ICMP应答数据包，给源主机A。

（4）如果没有返回或超时，认为网络不可达，除了检测可达性可以利用应答和发起时间计算数据包延迟。



### traceroute

作用：打印出可执行程序主机，一直到目标主机之前经历多少路由器。tracerounte利用ICMP协议定位计算机和目标计算机之间的所有路由器。由于ping命令不能完整记录所有的路由路径，所以有tracerounte语句。

原理：

（1）源地址A发出ICMP请求回显(ICMP Echo Request)数据包到达目的地址，TTL=1

（2）到达路由器，TTL减1

（3）TTL=0包丢弃，路由器向源地址发送一个ICMP超时通知（ICMP Time Exceeded Message），内容包含IP源地址，IP包的所有内容与路由器的IP地址。

（4）源地址收到该ICMP，包显示路由信息。

（5）重复（1）~（5）每次设置TTL增加1

（6）直到目标地址收到探测包，并且返回ICMP恢复。

（7）当源地址收到ICMP Echo Reply 停止trace。





