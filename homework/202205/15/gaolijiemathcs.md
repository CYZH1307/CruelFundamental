### TCP怎么保证传输过程的可靠性?

TCP的可靠传输是通过使用校验、序号、确认、重传等机制确保可靠性，TCP的可靠性是指能够提供可靠数据传输服务，保证接收方进程从缓冲区读出字节流与发送方发出的字节流完全一致。

#### 1、校验机制

同UDP做校验一致。校验和字段检验范围包括首部和数据两部分，在TCP报文段前面加上12B的伪部首，使用二进制反码求和再取反，校验部分包括首部和数据部分。

发送方将全0放入校验和字段，并且添加伪首部，将TCP报文看做许多16位字连接，通过二进制饭吗计算16位字的和，并将二进制反码写入校验和字段。发送时伪部首不向上传递也不向下传递，接收方将收到的TCP报文加上伪首部，按照二进制反码计算16位字的和（此时校验和不为0）当没有差错的时候结果全为1。校验的时候，TCP数据部分长度不是偶数个字节，需要在末尾写入全0字节。

#### 2、序号机制

TCP首部序号字段，保障数据有序提交给应用层，TCP将数据视为无结构但是有序的字节流。序号建立在字节流之上，不建立在报文段上。

TCP连接传送的数据流中的每个字节都编上一个序号。序号字段的值指本报文段发送的数据的第一个字节的序号。

一个报文可以有多个序号，例如第一个报文包含3个字节，序号为0~2，因此本报文序号为0。下一个报文序号为3.

#### 3、确认机制

TCP首部的确认号是期望收到对方的下一个报文的数据的第一个字节的序号。接收方是按序期望接收的，如果收到0~3报文（序号为0） 7~8报文（序号为7），接收方期望接收序号为4。发送方会缓存那些发送但是未收到确认号的报文段，以便重传。

TCP默认采用累积确认，TCP只确认数据流中第一个丢失字节为止的字节。接收方接收到0~3报文（序号为0） 7~8报文（序号为7），只会发送4的确认号，因此发送给接收方的确认号为4，表明0~3都接收到了。累积确认。

#### 4、重传机制

两种事件导致TCP对报文段进行重传：超时和冗余ACK

（1）超时重传

TCP每发送一个报文段，就会对报文段设置一个计时器。重传时间到期但是还未收到确认，就会重传这一报文段。TCP下层的互联网环境，IP报文路由变化大，因此往返时延变化大，因此TCP采用自适应的算法，记录一个报文发送到接收确认的时间，之差为报文段的往返时间RTT，TCP保留RTT的一个加权平均往返时间RTTS。会随着RTT变化变化。

（2）冗余ACK（冗余确认）

超时触发重传周期较大，因此通过冗余ACK来较好检测丢包情况。

冗余ACK为再次确认某个报文段的ACK，发送方已经接收到该报文的确认。

TCP规定了，每当收到一个比期望序列号大的失序报文，就会发送一个冗余ACK指明自己想接受的下一个字节的序列号。

例如接收方期望收到2序号报文，但是收到3 4 5序号报文，会发送3次对序号报文2的确认报文。接收方收到对同一个报文2号报文段收到3个冗余的确认报文，可以认为该报文已经丢失，发送方可以立即对报文进行重传。（快重传机制）。