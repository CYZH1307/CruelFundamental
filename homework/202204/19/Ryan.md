# 事务消息是否了解？场景题：比如下单清空购物车，你是如何设计的？

事务消息是分布式事务的其中一种实现方式，是为了在实时性要求不高的场景，基于消息队列MQ解决pub/sub一致性问题。其关键在于pub端，需要将pub动作拆分为预pub和最终pub两步，本地事务在这两步之间执行。
并提供一个反查pub端本地事务执行结果的接口，用来决定预pub到broker（MQ形式）的消息是被继续完整推送，还是回滚。

清空购物车设计如下：

    1.pub（订单系统）产生消息，发送一条预pub消息到MQ服务器
    2.MQ收到消息后，将消息持久化到存储系统，这条消息的状态是待发送状态。
    3.MQ服务器返回ACK确认到pub，此时MQ不会触发消息推送事件
    4.pub执行本地事务（订单创建成功，提交事务消息）
    5.如果本地事务执行成功，即commit执行结果到MQ服务器，MQ服务器更新消息状态为可发送；如果执行失败，发送rollback，让MQ服务器删除消息。
    6.如果消息状态更新为可发送，则MQ服务器会push消息给sub（购物车系统）。sub消费完（即拿到订单消息，清空购物车成功）就应答ACK。
    7.如果MQ服务器长时间没有收到pub的commit或者rollback，它会反查pub，然后根据查询到的结果（回滚操作或者重新发送消息）执行最终状态。
