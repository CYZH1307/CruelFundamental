# Redis持久化机制

Redis服务器是一个键值对数据库服务器，服务器中包含着若干个非空数据库，每个非空数据库可以包含任意个键值对，服务器中的非空数据库和它的键值对的状态统称为数据库状态。

Redis为内存数据库，将自己的数据库状态存在内存当中，如果服务器进程退出，服务器中的数据库会消失不见，因此需要做持久化，将内存中的数据库状态持久化到磁盘当中，以防数据丢失。

有两种持久化思路。

（1）RDB持久化(快照模式全量备份)

快照模式持久化，可以将某个时间点上的数据库状态，保存到一个RDB(Redis DataBase)文件当中。生成的RDB文件是一个经过二进制序列化压缩的文件，这个文件可以还原数据库状态，由于持久化到磁盘当中，即使系统Redis服务进程退出，甚至计算机停机，依据存储下的RDB文件也可以还原数据库状态。

①保存状态到RDB文件

Redis服务器保存RDB文件实现方式分为：SAVE命令方式和BGSAVE命令方式

- SAVE会阻塞Redis服务器进程，知道RDB文件创建完毕，在服务器进程阻塞过程中，服务器不处理任何命令请求。只有Redis服务器执行完SAVE命令以后，才会重新开始接受请求命令，客户端请求才会被处理。

- BGSAVE命令会派生出一个子进程，然后由子进程负责创建RDB文件，完成后向父进程发送信号，父进程继续处理命令请求，并且通过轮询的方式等待子进程的信号。

  注：RDB持久化：可以手动执行，也可以配置定期执行

②载入RDB文件恢复状态

创建可以选择方式，RDB文件载入则固定都是在服务器启动时自动执行的，只要Redis服务器启动的时候检测到RDB文件存在，就会自动载入RDB文件。

在载入RDB文件期间，系统一直处于阻塞状态，直到载入工作完成。

注意：下面的AOF方式的更新频率更高，当服务器开启AOF的功能，会优先用AOF文件还愿数据库状态。AOF功能关闭，才会用RDB方式。

③配置自动间隔保存

BGSAVE可以不阻塞服务进程执行，因此可以设置save选项，一段时间执行一次BGSAVE既可以间隔保存系统状态。系统通过配置文件设置save选项，设置服务器保存系统状态的条件，系统会设置如下：

- saveparams数组：设置redisServer的saveparams数组属性，数组元素为saveparam每个元素都保存了秒数和修改数。

- dirty计数器和lastsave属性：dirty计数器记录距离上一次成功执行SAVE/BGSAVE之后，服务器对数据库做了几次修改(写入、删除、更新等操作)；lastsave，为UNIX时间戳，记录服务器上一次成功执行SAVE或BGSAVE的时间。
- 操作serverCron函数：依据上面的参数，默认每100秒检查save设置的保存条件是否满足，满足就执行BGSAVE。

⑤RDB文件结构

- REDIS："REDIS"五个字符，载入文件检查是否为RDB文件。(二进制格式保存)

- db_version：4个字节，字符串表示的整数，记录RDB版本号。

- database：保存的数据内容，零个或者多个数据库，每个数据库的键值对数据。

  可以有多个非空数据库，如果有多个，则会保存多个数据库，每个非空数据库的格式包含了：

  - SELECTED: 读到这个，标识接下来将会读到一个数据库号码。
  - db_number: 数据库号码 select语句切换数据库
  - key_value_pairs: 保存数据库键值对，键值对带有过期时间，那么过期时间也会与键值对保存在一起。
    - 不带过期时间的键值对：TYPE、key、value组成。TYPE记录value的对象类型、底层编码，读入一个键值对数据，会依照TYPE的类型来决定怎么读入和解释value数据。(前一天作业内容)；key保存字符串对象；value保存值对象。
    - 带过期时间的键值对：EXPIRETIME_MS、ms、TYPE、key、value。后三个含义都一样，前两个中EXPIRETIME_MS用于标志后面为一个时间戳，ms为键值对的过期时间，毫秒为单位。

- EOF：标志正文结束，读到这个地方表示数据库读完了。

- check_sum：一个8字节的无符号整数，检验和，通过对上面4个部分计算得出来的，会对载入数据计算的校验和进行对比。

（2）AOF持久化(日志模式增量备份)

AOF(append only file)。与RDB持久化保存数据库中的所有键值对记录数据库系统状态。AOF为保存Redis服务器执行的写命令来记录数据库状态。客户端发送写命令给服务器，服务器会保存被执行的写命令，成为AOF文件。

例如一次SET、ADD、RPUSH组合操作，RDB是将这个操作完的数据库键值对状态保存下来，AOF是直接将三个命令保存下来。

AOF中的命令都是以Redis的请求协议格式保存下来的，纯文本格式。AOF日志是连续的增量备份，在长期运行过程，体量变大，宕机的话需要读取所有的日志文件进行恢复，耗时长，需要定期对AOF日志重写，瘦身日志。



未完待续 先交作业....



