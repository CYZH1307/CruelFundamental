### 4次挥手

**第一次挥手**： 客户端发送：FIN = 1，seq = x 的报文

**第二次挥手**： 服务器发送：ACK = 1，ACKnum = x + 1 的报文

**第三次挥手**： 服务器发送：FIN = 1，seq = y 的报文

**第四次挥手**： 客户端发送：ACK = 1，seq = y + 1 的报文



**Tip**:第二次挥手和第三次挥手均是服务器发起的

在发起第二次挥手后，服务器仍然可以send data，发起第三次挥手后，就不再send data，那么第二次挥手是不是没用？

不是的，客户端在收到第二次挥手的报文后会进入 FIN-WAIT-2状态，在接受第三次挥手后就发起第四次挥手，然后 wait for 2 * max segment lifetime后关闭



### 为什么挥手是4次？

我的理解（不一定正确）：挥手比握手多一次，就是第二次与第三次结合起来就可以类比到握手，在收到client的FIN后，服务器的数据可能还没发送完？

假设客户端是顾客，服务器是餐厅：

客户：开水白菜，烤鸭，回锅肉，114511瓶啤酒，FIN

服务器：送开水白菜，送烤鸭，送回锅肉，送啤酒ing，突然收到FIN，焯，先发一个“第二次挥手”应付一下，然后直到送完所有啤酒（不一定）然后“第三次挥手”

这里的啤酒还没有送完，客户就要溜了，可能是客户突然发现10w瓶太多了喝不完，就不要了？，对于餐厅（服务器），是否还要继续送啤酒，取决于餐厅经理（上层应用程序），得到上层应用程序指令后再发送 server FIN。



### 为什么要等待 2MSL

#### 1，保证服务器正常退出

假如服务器没有收到ACK报文的话，client在2MSL内收到重传的 FIN + ACK 报文，如果是这样client 继续发送ACK报文，同时重新启动2MSL计时器

收到的话服务器正常关闭，2MSL后client也正常关闭



