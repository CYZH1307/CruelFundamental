## C++中的内存优化采用两级的空间配置器机制来解决。

二级配置器结构：
1. 第一级配置器：
第一级配置器是以malloc(),remalloc(),free()等C函数执行实际的内存配置，释放，重新配置等操作。一级空间配置器分配的是大于128字节的空间。如果分配失败，调用句柄释放一部分内存。如果还是失败，调用一个指定的函数。

如果要分配的区块小于128字节，则以内存池进行管理，内存池又称为次层配置器(sub-allocation):每次配置一大块内存，并维护对应的16个空闲链表(free-list)，下次若有相同大小的内存需求，直接从free-list中取，若有小额区块被释放，则由配置器回收到free-list中。

在STL的第二级配置器中多了一些机制，避免太多小区块造成的内存碎片，小区块造成的不仅仅是内存碎片，同时还有一些额外的负担。区块越小，额外的负担所占的比重越大。

2. 内存池：
二级空间配置器：内存池采用了16个空闲链表，这里的16个空闲链表分别管理大小为8，16，24，32，……，120，128的数据块。这里的空闲链表的结点设计为一个联合体，既可以用来表示下一个空闲的数据块（存在于空闲链表中）的地址，也可以用来表示已经被用户使用的数据块（不存在与空闲链表中）的地址。

当用户申请的空间小于128字节，首先将字节数扩大到8的倍数，然后在自由链表中查找对应大小的子链表，如果在自由链表中查找不到或者块数不够，则向内存池进行申请，一般一次申请20块，如果不够分配20块，则分配最多的块数给自由链表，并且每次更新申请的块数。如果一块都无法提供，则把剩余的内存挂到自由链表，然后向堆申请空间，如果申请失败，则看看自由链表还有没有可用的块，如果也没有，最后调用一级空间配置器。



（1）使用allocate 向内存池请求size大小的内存空间，如果需要请求的内存大小大于128bytes,直接使用malloc。

（2）如果需要的内存大小小于128bytes, allocate 根据size找到最适合的自由链表。

a.如果链表不为空，返回第一一个node,链表头改为第二个node。

b.如果链表为空，使用blockA1loc请求分配node。
    
b1.如果内存池中有大于一个node的空间，分配竟可能多的node(但是最多20个)，将一个node返回，其他的node添加到链表中。
    
b2.如果内存池只有一个node的空间，直接返回给用户。
    
b3. 如果连一个node都没有，再次向操作系统请求分配内存。
    
①分配成功，再次进行b过程。
    
②分配失败，循环各个自由链表，寻找空间。
    
I.找到空间，再次进行过程b。
    
II. 找不到空间，抛出异常。

(3)用户调用deallocate释放内存空间，如果要求释放的内存空间大于128字节, 直接调用free。小于128字节按照其大小找到合适的自由链表，并将其插入。
