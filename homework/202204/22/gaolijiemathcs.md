### 谈谈什么是零拷贝

原有的数据拷贝过程，需要从内核缓冲区到用户缓冲区，再从用户缓冲区到内核缓冲区，进行拷贝。两次拷贝需要CPU参与并且需要用户态和内核态的多次切换，CPU负担重。

因此未来降低多余的数据拷贝与降低CPU压力，出现了零拷贝，目的是减少在数据传输过程中，CPU参与数据拷贝过程，以及减少内核态和用户态之间的切换次数。

零拷贝目前有mmap+write、sendfile、sendfile+DMA收集、splice等等。

（1）mmap方式：将内核中的读缓冲区地址与用户空间缓冲区地址进行映射，从而实现内核缓冲区与用户缓冲区的共享内存。减少1次用户态和内核态的CPU拷贝。但是内核空间中仍然有一次CPU拷贝，将内核缓冲区的数据拷贝到socket缓冲区当中。

mmap对大文件传输有优势，但是小文件可能有碎片。需要通过read()+write() 和 mmap()+write()

（2）sendfile方式：建立两个文件的传输通道。只需要通过sendfile()一个方法进行数据传输。减少用户态与内核态的状态切换次数。write()和read()各需要两次

（3）sendfile+DMA收集：sendfile的时候，内核缓冲区数据不直接CPU拷贝到套接字缓冲区，而是通过发送【fd文件描述符+地址偏移量等等通知socket缓冲区】，DMA通过fd和offset直接进行从内核缓冲区拷贝。CPU拷贝次数为0。

（4）splice：内核缓冲区和socket缓冲区之间建立管道来传输数据，避免CPU拷贝操作。DMA直接从socket缓冲区拷贝。小局限：splice两个文件描述符有一个需要是管道升。



ref:https://zhuanlan.zhihu.com/p/362499466