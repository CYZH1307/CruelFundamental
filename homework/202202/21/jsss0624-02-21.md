# 什么是五级流水线，数据冒险是什么

## 指令

### 指令的定义

> 计算机指令就是指挥机器工作的指示和命令，程序就是一系列按一定顺序排列的指令，执行程序的过程就是计算机的工作过程[百度百科](https://baike.baidu.com/item/%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%8C%87%E4%BB%A4/1490932?fr=aladdin)。

### 指令的结构

指令包含了**操作码**和**操作数**. 操作码决定该条指令的作用（运算类(add、mul、sub)、控制跳转(JA、JE)、取值(lea)）; 操作数指定了参与指令操作的具体数据, 操作数可以是**立即数**(如`add eax, 10`, 其中10为立即数), 可以来自**寄存器**(如`mov eax, esp`), 也可以来自**内存**(如`mov eax, 某内存地址(逻辑地址)`).

根据操作数的多少, 指令可以分为无操作数指令(`ret`)、一操作数指令`JE, INC`、二操作指令(`mov`)和三操作数指令(`add`)等等。

## 五级流水线

> **cpu流水线技术**是一种将指令分解为多步，并让不同指令的各步操作重叠，从而实现几条指令并行处理，以加速程序运行过程的技术[百度百科](https://baike.baidu.com/item/cpu%E6%B5%81%E6%B0%B4%E7%BA%BF/4421101?fr=aladdin)。

MIPS五级流水线分为五个模块: **取址** -> **译码** -> **执行** -> **访存** -> **写回**

1. **取址**: 控制单元根据`PC`中存放的指令地址, 从存储器中取出下一条即将执行的指令放入指令寄存器.
2. **译码**: 根据指令编码的规则去对指令进行译码. 即翻译指令, 看看指令具体是什么操作, 需要几个操作数, 操作数是立即数还是在寄存器或内存里, 并给出操作数的地址以及结果的保存地址等.
3. **执行**: 有了操作码和操作数, 就根据操作码对操作数进行操作, 即执行指令.
4. **访存**: 访存是`load \ store`, 即读内存或写内存. 内存操作数需要读内存, 有些结果的保存需要写入内存. (读写内存远远慢于读写寄存器, 可以利用`cache`加速, 但可能还会遇到缺页中断的问题).
5. **写回**: 将指令执行的结果写入寄存器中或内存中.

## 数据冒险

流水线技术通过并行处理来加速程序的执行过程, 但有些情况下这种并行会导致使用数据存在冒险: **当前指令需要需要使用之前指令的运算结果, 但是其结果没有写回**.

![example](https://cdn.jsdelivr.net/gh/CsJsss/CsJsss.github.io@hexo/themes/icarus/source/img/2022/1/data.png)

如图, `add`指令需要`t0`作为操作数参与运算, 但其被上一条指令`sub`操作, 而且其结果还未写回. 此时存在数据冒险.

### 解决方法

1. 插入nop指令. (软件解决方法, 不足在下面参考博客中)
2. 流水线停顿, 增加气泡.
    ![pause](https://cdn.jsdelivr.net/gh/CsJsss/CsJsss.github.io@hexo/themes/icarus/source/img/2022/1/pause.png)
3. 数据前递.
   t0在EX阶段(执行)就被计算出，所以可将它送到下一条指令ALU的输入，而不需要添加气泡。
   ![forwarding](https://cdn.jsdelivr.net/gh/CsJsss/CsJsss.github.io@hexo/themes/icarus/source/img/2022/1/forwarding.png)
## 参考

[数据冒险讲解博客](https://www.cnblogs.com/lfri/p/10053598.html)
