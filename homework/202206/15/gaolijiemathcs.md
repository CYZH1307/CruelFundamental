### 原子操作是如何实现的？

cpu硬件支持lock指令，底层硬件支持。

（1）通过总线BUS锁保证原子操作：英特尔处理器提供一个LOCK#信号，在某些关键内存操作期间会自动断言，锁定系统总线，在断言输出信号的时候，其他处理器或者总线代理控制总线的请求将被阻塞。一个处理器在总线上输出此信号，其他处理器的请求将会被阻塞，则独占共享内存。性能消耗大。

锁定进入操作总线的一条信息组成，发送消息的内核需要等待其他内核完成正在执行的操作，然后他们确认被锁定，只有在所有内核都确定以后，该尝试锁定操作的内核才能继续进行，当锁被释放，会向总线上其他核发送恢复操作。

（2）缓存锁保证原子性：内存区域如果被缓存在处理器缓存行，则Lock期间被锁定，当执行锁操作协会到内存的时候，处理器不在总线上声明Lock信号，而是修改内部的内存地址，并且允许缓存一致性机制（MESI协议）来保证操作的原子性，因为缓存一致性机制会阻止同时修改两个以上处理器缓存的内存区域数据。当其他处理器回写已被锁定的缓存行的数据时，会使缓存行无效。





ref:

https://www.cnblogs.com/cnblogs-wangzhipeng/p/12549179.html