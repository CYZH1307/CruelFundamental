## 描述一下JVM加载class文件的原理机制

类加载子系统负责从文件系统或者网络中加载class文件，class文件在文件开头有特定的文件标识。

类加载过程包括：加载阶段、链接阶段(验证、准备、解析)和初始化阶段

类加载过程：

### 加载阶段

这里的"加载"是"类加载"的一个阶段。

（1）通过一个类的全限定名称获取该类的二进制字节流。

（2）将二进制字节流代表的静态结构转化为方法区的运行时数据结构。

（3）在内存中创建一个代表该类的java.lang.Class对象，作为方法区这个类的各种数据访问入口。

注：这里会使用到类加载器，由上到下的为启动类加载器、扩展类加载器、应用程序类加载器、自定义类加载器(可以有多个)。各种类加载之间的层次关系称为类加载器的双亲委派机制。如果一个类加载器接收到了类加载的请求，不会自己尝试加载这个类，而是将请求委托给父类加载器去加载，直到顶层的启动类加载器，只有父类加载器反馈无法完成这个加载请求（搜索范围内没有找到这个类），子加载器才会去加载。可以保证基础行为的一致性。

### 链接阶段

（1）验证：

验证阶段确保Class文件的字节流中包含的信息符号当前虚拟机的要求，不会危害虚拟机自身安全。

- 文件格式验证：字节流是否符合Class文件格式规范，并且版本可以被虚拟机处理。例如是否以魔数开头、版本号验证、常量池常量类型检查等等。
- 元数据验证：字节码描信息进行语义分析，确保符合Java语法规范。
- 字节码验证：对方法体进行语义分析。
- 符号引用验证：确保解析正常执行

（2）准备：为类变量分配内存并且设置该类变量的默认初始值，零值。

（3）解析：将常量池中的符号引用转换为直接引用。

### 初始化阶段

执行类构造器方法\<clinit>()过程。执行构造器过程。如果有父类，则会保证父类先加载完毕，再加载子类的。

对静态变量和静态代码块执行初始化工作。

- \<client>()方法是有编译器自动收集类中的所有类变量赋值动作和静态语句块语句合并以后形成的。

- 虚拟机会保证父类的的\<client>()方法执行在子类的\<client>()方法之前执行。
