# TCP是怎么保证有序传输的，知不知道 time_wait状态，这个状态出现在什么地方，有什么用

首先TCP通过三次握手后交换双方的初始的`seq`. 接着在后续的通信中通过`ack`进行累计确认包是按序接收的. 并且使用滑动窗口以及拥塞控制算法来动态控制发送窗口的大小. 

`time_wait`是四次挥手阶段中最后一次挥手, 当挥手发起方受到对方发送的`FIN = 1`的包后, 发送`ack`确认包给对端, 并设定计数器, 在两倍最大报文存活时间后关闭TCP连接. 该阶段称为`time_wait`状态, 设置两倍最大报文存活时间后关闭TCP连接的原因是:

1. 保证发送给对端的最后一个`ack`包能够到达, 如果丢失, 对端超时后会重发`FIN = 1`ack包, 等待2 * MSL的时间后关闭就是为了处理这种情况.
2. 保证本次连接产生的包在网络中全部消失, 避免下次TCP连接收到旧的包.


`time_wait`状态连接过多的危害:

1. `time_wait`状态下, TCP连接占用的端口无法释放.
2. 当大量的连接处于`time_wait`时，新建立tcp连接会出错


解决`time_wait`状态连接过多的方法:

1. 客户端: 使用长连接, `HTTP`请求的头部中`connection`字段设置为`keep-alive`
2. 服务器端允许`time_wait`状态的socket被重用, 减少`time_wait`时间(可能会导致出错).