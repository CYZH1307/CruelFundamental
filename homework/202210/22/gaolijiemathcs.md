### 如果让你实现一个traceroute，该怎么实现？

#### 基于UDP实现

在基于UDP的实现中，客户端发送的数据包是通过UDP协议来传输的，使用了一个大于30000的端口号，服务器在收到这个数据包的时候会返回一个**端口不可达**的ICMP错误信息，客户端通过判断收到的错误信息是TTL超时还是端口不可达来判断数据包是否到达目标主机，具体的流程如图：

1、客户端发送一个TTL为1，端口号大于30000的UDP数据包，到达第一站路由器之后TTL被减去1，返回了一个超时的ICMP数据包，客户端得到第一跳路由器的地址。

2、客户端发送一个TTL为2的数据包，在第二跳的路由器节点处超时，得到第二跳路由器的地址。

3、客户端发送一个TTL为3的数据包，数据包成功到达目标主机，返回一个**端口不可达**错误，traceroute结束。

#### 基于ICMP实现

上述方案失败的原因是由于服务器对于UDP数据包的处理，所以在这一种实现中我们不使用UDP协议，而是直接发送一个**ICMP回显请求（echo request）**数据包，服务器在收到回显请求的时候会向客户端发送一个**ICMP回显应答（echo reply）**数据包，在这之后的流程还是跟第一种方案一样。这样就避免了我们的traceroute数据包被服务器的防火墙策略墙掉。

采用这种方案的实现流程如下：

基于ICMP实现的traceroute

1、客户端发送一个TTL为1的**ICMP请求回显**数据包，在第一跳的时候超时并返回一个ICMP超时数据包，得到第一跳的地址。

2、客户端发送一个TTL为2的ICMP请求回显数据包，得到第二跳的地址。

3、客户端发送一个TTL为3的ICMP请求回显数据包，到达目标主机，目标主机返回一个**ICMP回显应答**，traceroute结束。



ref:https://www.jianshu.com/p/75a5822d0eec