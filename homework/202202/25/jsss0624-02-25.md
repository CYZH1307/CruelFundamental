# a、b两台服务器怎么判断是否能连通, 为什么能用ping和traceroute

## ping

**ping**主要用于确定网络间的连通性以及网络间的连接状况. 其是基于**ICMP协议**工作的. ping命令会构建一个ICMP请求报文给目标主机, 并等待目标主机返回ICMP应答报文.

### 源主机工作流程

1. ping目标主机后ICMP协议构建ICMP请求报文
2. IP层协议得到ICMP报文以及目标主机IP地址后, 将本机地址作为源地址, 再加上其他的一些控制信息组成IP数据包.
3. 根据本地ARP缓存查找目标IP地址对应的MAC地址(物理地址). 如果没找到就通过ARP协议找. 最后将目标主机的MAC地址和本机的MAC地址交给数据链路层, 构造数据帧.
4. 通过物理层发送给目标主机

### 目标主机工作流程

1. 物理层收到二进制数据流经过数据链路层, 根据以太网协议解析出数据帧, 判断数据帧中的目标MAC地址是否为本机, 是则接受, 否则抛弃.
2. 经过网络层解析IP数据包, 通过IP包头的协议字段判断出是ICMP报文. 之后ICMP协议处理, 构建并发送一个ICMP应答报文. 
3. 将封装好的ICMP应答报文经过网络层、数据链路层、物理层发送回源主机.

## Traceroute

**traceroute**命令不仅可以检测网络间是否联通, 还可以知道从源主机到目标主机经过了哪些路由器. 其可以通过利用ICMP协议定位路径上经过的路由器. 并利用**端口不可达**错误来确定数据包是否到达目标主机.

### 工作流程

1. 源主机向目标主机发送一系列的UDP报文. 第一个报文的生存时间TTL = 1, 当其到达路径上第一个路由器时, 该路由器将TTL值减1, 并发现TTL = 0. 因此路由器将其丢弃, 并发送给源主机ICMP不可达的报文. 
2. 主机收到ICMP不可达报文后, 接着发送TTL = 2的报文, 这样确定路径上第2个路由器.
3. 这样循环往复, 直到数据报到达目标主机, 由于traceroute发送的是端口号大于30000的UDP报文, 因此目标主机只能发送一个端口不可达的ICMP数据包(无法交付的UDP报文)给源主机.
4. 通过这种方法源主机知道了到目标主机路径上的路由器的IP和目标主机是否联通等信息.
