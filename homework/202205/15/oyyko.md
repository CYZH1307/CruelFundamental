TCP 是通过下面几个特性保证数据传输的可靠性：

- **序列号和确认应答信号**
- **超时重发控制**
- **连接管理**
- **滑动窗口控制**
- **流量控制**
- **拥塞控制**

### 通过序列号和确认应答信号提高可靠性

在 TCP 中，当发送端的数据到达接收主机时，接收端主机会返回一个已收到消息的通知，这个消息叫做**确认应答（ACK）**。当发送端将数据发出之后会等待对端的确认应答。如果有确认应答，说明数据已经成功到达对端。反之，则数据丢失的可能性很大。

但是，如果在一定时间内发送端都没有得到确认应答ACK，发送端就会认为数据丢失，并进行**数据重发**。所以，即使产生了丢包，TCP仍然能保证数据能够到达对端，实现可靠的传输。

虽然目标主机通过重发数据可以提供可靠的传输，但是对于目标主机来说，反复收到相同的数据可能会是一个”灾难“，既浪费网络资源，还要耗资源对它处理。

所以，我们**需要一种机制来识别是否已经接收到了这个数据包、又能够判断数据包是否需要接收。**

目标主机反复收到相同数据是不可取的，为了保持数据的一致性，目标主机必须扔掉重复的数据包，那么怎么判断该数据包是已经重复收取过呢？ 为此我们引入了**序列号**。

序列号是按照顺序给发送数据的每一个字节（8位字节）都标上号码的编号。接收端查询接收数据 TCP 首部中的序列号和数据的长度，将自己下一步应该接收的序列号作为确认应答返送回去。**通过序列号和确认应答号，TCP 能够识别是否已经接收数据，又能够判断是否需要接收，从而实现可靠传输。**

所以，通过序列号，上面说的**确认应答ACK处理， 重发控制，重复控制**都能实现了。



### 超时重发如何确定呢？

- **重发超时是指在重发数据之前，等待确认应答到来的那个特定时间间隔**。如果超过这个时间仍未收到确认应答，发送端将进行数据重发。 最理想的是，找到一个最小时间，它能保证“确认应答一定能在这个时间内返回”。
- TCP 要求不论处在何种网络环境下都要提供高性能通信，并且无论网络拥堵情况发生何种变化，都必须保持这一特性。为此，它在每次发包时都会计算往返时间（RTT Round Trip Time）及其偏差（RTT波动的时间，也叫抖动）。**将这个往返时间和偏差时间相加，重发超时的时间就是比这个总和要稍大一点的值。**
- 重发超时既要考虑RTT往返时间，又要考虑网络抖动的偏差，网络网络环境不同可能会造成RTT大幅度摆动，TCP/IP的目的就是即使在这种环境下也能进行控制，不浪费网络流量。

- 在 BSD 的 Unix 以及 Windows 系统中，超时都以0.5秒为单位进行控制，因此重发超时都是0.5秒的整数倍。不过，最初其重发超时的默认值一般设置为6秒左右。
- 数据被重发之后若还是收不到确认应答，则进行再次发送。此时，等待确认应答的时间将会以2倍、4倍的指数函数延长。
- 此外，数据也不会被无限、反复地重发。达到一定重发次数之后，如果仍没有任何确认应答返回，就会判断为网络或对端主机发生了异常，强制关闭连接。并且通知应用通信异常强行终止。



### 连接管理

TCP是**面向连接**的通信协议，面向连接是指在数据通信之前先做好通信两端之间的准备工作。

因此，在数据通信之前，会通过TCP首部发送一个`SYN`包作为建立连接和等待确认应答，如果对端发来确认应答ACK，则认为可以进行通信，否则如果对端没有发送正确的ACK应答，那么就不会通信。

另外通信完毕需要发送`FIN`包来关闭连接

这就是我们常常说的 **三次握手建立连接 和四次挥手关闭连接**

### TCP是以段为单位进行数据包的发送的

在建立 TCP 连接的同时，也可以确定发送数据包的单位，我们也可以称其为**“最大消息长度”（MSS，Max Segment Size）**，也就是一个段。最理想的情况是，最大消息长度正好是 IP 中不会被分片处理的最大数据长度。

TCP 在传送大量数据时，是以 MSS 的大小将数据进行分割发送。进行重发时也是以 MSS  为单位。

MSS 在三次握手的时候，在两端主机之间被计算得出。两端的主机在发出建立连接的请求时，会在 TCP 首部中写入 MSS  选项，告诉对方自己的接口能够适应的 MSS 的大小。然后会在两者之间选择一个较小的值投入使用。

### 利用滑动窗口控制提高速度

上面说了，TCP 以1个段为单位，如果每发送一个段进行一次确认应答，才能进行下一次通信，那这样的传输方式有一个缺点，就是包的往返时间（RTT）越长通信性能就越低.

为解决这个问题，TCP 引入了**窗口**这个概念。**确认应答不是以每个分段来确认，而是以更大的单位进行确认**，转发时间将会被大幅地缩短。也就是说，**发送端主机，在发送了一个段以后不必要一直等待确认应答，而是继续发送**。

**窗口大小就是指无需等待确认应答ACK而继续发送数据的最大值**。