# How does the TCP layer ensure reliable byte flow

TCP layer realizes reliable data transmission in unreliable IP network through complex mechanism. It includes data
sorting, de-redundancy, packet loss and re-transmission, data verification, and flow control considering the operation
of the receiver and congestion control considering the operation of the intermediate router.

## Byte sorting

When one end sends a stream of bytes to the other end, how does the other end know if the data in the middle is missing
or duplicated? Simple, each byte in the byte stream is number labeled. When a TCP segment is lost during transmission,
the receiver knows the sequence number of the missing TCP segment by sequence number, and can also discard duplicate
data by sequence number. In the figure below, in order to illustrate the sorting of data, the byte number starts from 1.
In practice, the initial number of the byte does not start from 1, but the value generated by the system according to a
certain algorithm. This value is called the Initial Sequence Number. ISN value in the range of [0, 2 ^ 32-1), after the
value of more than 2 ^ 32-1, start counting from 0 again. When TCP layer segments the byte stream data of application
layer, it will not only put 3 bytes in one Segment, but Segment according to the specific situation. The maximum value
of byte stream Segment is called MSS (Max Size Segment).

Data verification When each byte of the byte stream arrives in sequence at the receiving end, the data at the receiving
end may be inconsistent with the data content at the sending end due to unpredictable accidents in the transmission
link. So the TCP layer provides data validation before and after sending. When a TCP segment data before sending, TCP
module add temporary segment data on the source IP address, destination IP address, TCP protocol type, calculation of
the length of the TCP segment, will be appended to these a few elements to send TCP segment, forming a temporary data
structure, and for the calibration and checksum calculation, calculation result will be added to the TCP segment data.
When this data arrives at the receiving end, the receiving end performs the above calculation again and gets checksum
again, and then compares it with checksum in the TCP segment. If it is consistent, it indicates that the data is
reliable.

## Acknowledge mechanism

Sorting the byte stream data lets the receiver know whether data is lost in transit, but what can be done to remedy the
loss? In TCP, the receiver informs the sender of the received data, that is, confirms the received data. When the
sending end fails to receive the confirmation from the receiving end for the segment data starting with serial number N
within a certain period of time, the sending end considers that the segment data of serial number N is lost, and the
sending end retransmits the TCP segment marked with serial number N.

As shown in the figure below, the segment DATA [DATA: 5,6,7] is sent from the client to the server. After the server
receives [DATA: 5,6,7], it replies [ACK: 8], indicating that it has received all DATA before the seventh byte and
expects to receive DATA starting from the eighth byte. The DATA [DATA: 8,9,10] is sent from the client to the server.
This DATA does not reach the server, but is lost in the network. The client starts timing when sending the DATA. Piece
of DATA [DATA: 11] from the client sends to the server, the server receives DATA: 11 after, reply [ACK: 14], reply
period of DATA loss in the network, the same as the last time, timing starts when the client sends a DATA, after a
certain period of time, the client didn’t receive the service side of this piece of DATA confirmation reply, the client
to send the DATA.

## Flow control

When the rate of sending data exceeds the processing capacity of the receiver, the receiver informs the sender to slow
down the speed of sending data. This will be explained in detail when TCP sliding window mechanism is explained.

## Congestion control

This section will be explained in detail in the TCP congestion control instructions.


***
[reference](https://totozhang.github.io/2016-01-03-tcp-reliable-communication/）)