# Redis数据过期后的删除策略？

数据库键的过期时间都保存在过期字典当中，通过过期时间可以判断一个键是否过期。

三种过期删除策略：定时删除、惰性删除、定期删除

- 定时删除：设置键的过期的时间同时，创建一个定时器，定时器在键过期时间来临，立即执行对键的删除。
- 惰性删除：放任键过期不管，每次从键空间获取键的时候，都检查取得的键是否过期，如果过期就删除。没有过期则返回。
- 定期删除：每隔一段时间，检查一次删除过期键。

### 1 定时删除

（1）定义：定时删除在设置键的过期时间的同时，创建一个定时器(timer)，让定时器在键的过期时间来临的时候，立刻执行对键的删除操作。

（2）优点：对内存最友好，通过使用定时器，定时删除策略可以保证过期键将会尽可能快的被删除，并且释放过期键所占用的内存。

（3）缺点：对CPU时间不友好，在过期键比较多的时候，删除过期键可能会占用相当一部分CPU时间，在内存不紧张，但是CPU时间紧张的情况下，将CPU时间用在删除和当前任务无关的键，是对服务器响应时间和吞吐量造成影响的行为。

### 2 惰性删除

（1）定义：程序只会在取出键的时候才对键进行过期检查，保证删除过期键的操作只会在必须要做的时候才进行，删除的目标仅限于当前处理的键，这个策略不会在删除其他无关的过期键上花费CPU时间。

（2）优点：对CPU时间最友好，只对当前用到处理的键进行判断。

（3）缺点：对内存不友好，如果一个键已经过期，这个键又仍然保存在数据库中，那么这个过期键不被删除，占用的内存就不会释放。如果数据库有很多过期键，这些过期键恰好没有被访问到，有可能会一直停留在内存当中(除非手动删除)，可以看做一种内存泄露(无用数据占用内存，而服务器不会释放)，而Redis服务器依赖内存。例如日志过期没有自动删除，则影响Redis使用。

### 3 定期删除

（1）定义：每隔一段时间执行一次删除过期键操作，通过限制删除操作执行时长和频率减少删除对CPU时间的影响。为定时和惰性删除折中策略。

（2）优点：减少惰性删除内存浪费。减少定时删除，频繁占用CPU时间影响。

（3）难点：确定删除操作的执行时长与间隔时间频率。太过频繁，或者执行删除时间太长，定期删除策略就退化维定时删除策略，消耗浪费CPU时间。如果删除执行时间太少，或执行时间太短，则定期删除与惰性删除一样，会有内存浪费的情况出现。



### 4 实现细节

Redis数据库由dict字典和expires字典构成，dict字典存储键值对，expires保存键的过期时间。

expires字典键指向数据库中的某个键，而值记录了数据库键的过期时间，过期时间是一个以毫秒为单位的UNIX时间戳。

执行SAVE命令或者BGSAVE命令产生新的RDB文件不会包含已经过期的键。

当一个过期键被删除以后，服务器会追加一条DEL命令到现有AOF文件末尾，显式删除过期键。

当主服务器删除一个过期键后，他会向所有服务器发送一条DEL命令，显式删除。

当服务器即使发现过期键，也不会自作主张删除，而是等待主节点发来DEL命令，统一、中心化的过期键删除策略，保证主从服务器的数据一致性。



