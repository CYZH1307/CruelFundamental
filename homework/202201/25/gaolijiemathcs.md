# 什么是MVCC？

（1）定义：MySQL等大多数事务型存储引擎，实现都不是使用简单的行级锁，基于对并发性能考虑，都使用多版本并发控制(MVCC)，可以看做是行级锁的一种变种，很多情况避免了加锁的操作，大多实现了非阻塞的读操作，写操作也只锁定必要的行，降低开销。

（2）MVCC的实现：通过保存数据在某个时间点的快照来实现，不管执行需要多长时间，每个事务看到的都是一致的，根据事务开始的时间不同，每个事务对同一张表，同一时刻看到的数据可能是不一样的。



（3）悲观锁与乐观锁

- 悲观锁：
  - 对数据被外界(包括本系统的事务，与外界的事务处理)修改持保守态度。在数据处理过程中，数据处于锁定状态。悲观锁实现，依靠数据库提供的锁机制。
  - 悲观锁，为了保证事务的隔离性，需要一致性锁定读，read读取数据的时候加锁，其他事务无法修改这些数据.修改update删除delete数据也要加锁，其他事务无法读取这些数据。
  - 使用数据库的锁机制实现，问题是会带来数据库性能开销，尤其是长事务，开销往往无法承受。
- 乐观锁：
  - 采取宽松加锁机制，一定上解决了悲观锁，使用数据库的锁机制，带来的系统开销问题。
  - 乐观锁，大多基于数据版本(version)记录机制实现。也即为数据加一个版本标识，例如对数据库表加上一个version字段，读取数据时，将版本号一起读出来，之后更新数据的时候对version版本+1.
  - 将提交数据的版本数与数据库表对应记录的当前版本号作为对比，如果提交的数据版本号大于当前数据库当前版本号，则进行更新，否则认为是过期的数据。



（4）分类：乐观并发控制，和悲观并发控制。

InnoDB的MVCC，通过在每行记录后面保存两个隐藏列实现，**行的创建时间**+**行的过期时间**(或删除时间)。这两个值一个记录这行数据什么时候被创建，另外一个记录这个行数据什么时候过期(或被删除)。实际不是存具体时间值，而是存事务版本号，每开启一个新事务，版本号都会自动递增。事务开始的系统版本号会作为本事务的版本号，用来和查询到的版本号进行比较。

在REPEATABLE READ可重复读隔离级别下，MVCC具体操作：

- Select
  - Innodb根据以下两种条件检查每行数据：
    - 读取创建版本号<=当前事务版本号。InnoDB只查找版本早于当前事务版本的数据行(行系统版本号<=事务系统版本)，确保事务读取的行，要么是在事务开始前已经存在，或者是事务自身插入或修改过的行。
    - 删除版本号为空或<=当前事务版本号。行的删除版本，要么没定义，要么大于当前事务版本号。确保事务读取到的行，在事务开始之前未被删除。
  - 只有符合上面两个条件的记录，才能返回作为查询结果。
- Insert
  - Innodb为新插入的每一行保存当前系统事务版本号作为版本号。
- Delete
  - Innodb为删除的每一行保存当前系统事务版本号作为行的删除版本号。
- Update
  - Innodb为插入一行新记录，保存当前系统版本号作为版本号，同时保存当前系统版本号到原来的行作为行删除标识。



保存两个额外系统版本号，大多数操作不用加锁，这样设计使得读数据操作简单，性能好，保证只会读取到符合标准的行，不足是记录需要额外存储空间，并需要额外检查。MVCC只在RR和RC级别下工作，其他不兼容，RU总是读最新行，不符合当前事务版本的数据行，SERIALIZABLE会对读取的行都加锁。
