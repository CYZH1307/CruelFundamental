### 为什么事务提交了但是数据没有保存？

事务提交数据保存，数据保存可以看做是成功持久化到磁盘，并且能够通过查询查找到保存的数据。

想法：

（1）可能情况1：就是事务提交以后，数据库出现了问题，异常重启。无法崩溃恢复，数据没有保存下来。

innodb中两阶段提交用于崩溃恢复：

两阶段提交redo log和binlog能够搭配支持数据库的崩溃恢复。但是也存在无法恢复，回滚的情况。

- 处于写入redolog后处于prepare状态、但是在写入binlog之前，发生崩溃，这个时候binlog还没写，redolog还处于未提交状态，这个事务会回滚，此时binlog没有写不会传到备库当中。
- 处于binlog写完，redolog还没commit状态的时候崩溃，会依据日志情况判断：
  - 如果redo log中事务是完整的，已经有commit标志，那么会直接提交。
  - 如果redo log中事务只有完整的prepare，则判断事务的binlog是不是存在并且完整。如果binlog存在并且完整，则可以提交事务。否则会回滚。查找不到数据。



（2）可能情况2：读写分离，事务提交后，查找数据走的是从库。当主从出现延迟的时候，查询发现数据没有保存下来。

主从出现延迟可能的原因：

从库执行日志的速度远低于主库生成日志的速度。

- 备库所在机器性能比主库机器性能差。
- 备库查询压力大，影响同步速度。（可以采用一主多从，或外部系统订阅binlog分摊从库查询压力。）
- 大事务，例如大表删除，导致主备延迟。
- 备库并行复制能力低（可以开并行复制）

但这些只是主从延迟，导致感受上数据没保存，但是充分的时间，从库可以赶上主库。