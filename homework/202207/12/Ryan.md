# 什么是内存屏障？

内存屏障是一种能拦截任何进程/线程并迫使其等待的barrier指令，使得 CPU 或编译器在对内存进行操作的时候，严格按照一定的顺序来执行，同时也会迫使缓存中的内容直接落入内存。也就是说在内存屏障之前的指令和之后的指令、操作结果不会由于系统优化等原因而导致乱序。  

大多数现代计算机的编译器为了提高性能而采取乱序执行，在多线程场景下，有可能打乱了多线程之间的前后逻辑，导致出现非预期结果。这使得内存屏障在多线程开发中是工程师必须掌握的。  

按缓存内存的数据关系，屏障分四种（Load对应的是内存到缓存，Store对应的是缓存到内存）：  
 - LoadLoad 屏障：	x;|barrier|;y;	该屏障确保x数据的Load先于y及其后所有Load的的操作
 - StoreStore 屏障：	x;|barrier|;y;	该屏障确保x立刻Store(使其对其他处理器可见)，完成后才能进行y及其后所有Store的操作
 - LoadStore 屏障：	x;|barrier|;y;	确保x的Load先于y及其后所有Store的操作
 - StoreLoad 屏障：	x;|barrier|;y;	该屏障确保x处Store先于y及其后所有Load的操作。这会使线程在该屏障之前的所有Load和Store完成之后，才能越过该屏障继续执行

可以看到，StoreLoad屏障同时具备了前面三者的功能（类似互斥锁），实现相对简单，但相应地，开销也是最大的。它也叫做全能屏障（mfence），大多数市面上处理器至少支持该种屏障。
