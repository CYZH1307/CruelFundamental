**主从数据库**是什么意思呢，主是主库的意思，从是从库的意思。数据库主库对外提供读写的操作，从库对外提供读的操作。

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/83abaffb40cc4420906892e8d9beeb44~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp)

**数据库为什么需要主从架构呢？**

- 高可用，实时灾备，用于故障切换。比如主库挂了，可以切从库。
- 读写分离，提供查询服务，减少主库压力，提升性能
- 备份数据，避免影响业务。

### 数据库主从复制原理

**主从复制原理**，简言之，分三步曲进行：

- 主数据库有个`bin log`二进制文件，记录了所有非查询`SQL`语句。（binlog线程）
- 从数据库把主数据库的`bin log`文件的`SQL` 语句复制到自己的中继日志 `relay log`（io线程）
- 从数据库的`relay log`重做日志文件，再执行一次这些sql语句。（Sql执行线程）

主从复制过程分了五个步骤进行：

1. 主库的更新SQL(update、insert、delete)被写到binlog
2. 从库发起连接，连接到主库。
3. 此时主库创建一个`binlog dump thread`，把`bin log`的内容发送到从库。
4. 从库启动之后，创建一个`I/O`线程，读取主库传过来的`bin log`内容并写入到`relay log`
5. 从库还会创建一个SQL线程，从`relay log`里面读取内容，从`ExecMasterLog_Pos`位置开始执行读取到的更新事件，将更新内容写入到`slave`的db




### 长链接

主库和从库在同步数据的过程中断怎么办呢，数据不就会丢失了嘛。因此主库与从库之间维持了一个**长链接**，主库内部有一个线程，专门服务于从库的这个**长链接**的。

### binlog格式

binlog 日志有三种格式，分别是`statement，row和mixed`。

如果是`statement`格式，binlog记录的是**SQL的原文**，如果主库和从库选的索引不一致，可能会导致主库不一致。我们来分析一下。假设主库执行删除这个SQL（其中`a和create_time`都有索引）如下：

```
delete from t where a > '666' and create_time<'2022-03-01' limit 1;
复制代码
```

我们知道，数据选择了`a`索引和选择`create_time`索引，最后`limit 1`出来的数据一般是不一样的。所以就会存在这种情况：在binlog = `statement`格式时，主库在执行这条SQL时，使用的是索引a，而从库在执行这条SQL时，使用了索引`create_time`。最后主从数据不一致了。

**如何解决这个问题呢？**

可以把binlog格式修改为`row`。`row`格式的`binlog`日志，记录的不是**SQL原文**，而是两个`event:Table_map 和 Delete_rows`。Table_map event说明要操作的表，Delete_rows event用于定义要删除的行为，记录删除的具体行数。`row`格式的binlog记录的就是要删除的主键ID信息，因此不会出现主从不一致的问题。

但是如果SQL删除10万行数据，使用row格式就会很占空间的，10万条数据都在binlog里面，写binlog的时候也很耗IO。但是`statement`格式的binlog可能会导致数据不一致，因此设计MySQL的大叔想了一个折中的方案，`mixed`格式的binlog。所谓的mixed格式其实就是`row`和`statement`格式混合使用，当MySQL判断可能数据不一致时，就用`row`格式，否则使用就用`statement`格式。

**主从延迟**是怎么定义的呢？ 与主从数据同步相关的时间点有三个

1. 主库执行完一个事务，写入binlog，我们把这个时刻记为`T1`；
2. 主库同步数据给从库，从库接收完这个binlog的时刻，记录为`T2`；
3. 从库执行完这个事务，这个时刻记录为`T3`。

所谓主从延迟，其实就是指同一个事务，在从库执行完的时间和在主库执行完的时间差值，即`T3-T1`。

**哪些情况会导致主从延迟呢？**

1. 如果从库所在的机器比主库的**机器性能差，会导致主从延迟**，这种情况比较好解决，只需选择**主从库一样规格的机器**就好。
2. 如果**从库的压力大，也会导致主从延迟**。比如主库直接影响业务的，大家可能使用会**比较克制**，因此一般**查询都打到从库**了，结果导致从库查询消耗大量CPU，影响同步速度，最后导致主从延迟。这种情况的话，可以搞了**一主多从**的架构，即多接几个从库分摊读的压力。另外，还可以把binlog接入到Hadoop这类系统，让它们提供查询的能力。
3. **大事务也会导致主从延迟**。如果一个事务执行就要10分钟，那么主库执行完后，给到从库执行，最后这个事务可能就会导致从库延迟10分钟啦。日常开发中，我们为什么特别强调，不要一次性delete太多SQL，需要分批进行，其实也是为了避免大事务。另外，大表的DDL语句，也会导致大事务，大家日常开发关注一下哈。
4. **网络延迟**也会导致主从延迟，这种情况你只能优化你的网络啦，比如带宽20M升级到100M类似意思等。

### 主从复制的作用（好处，或者说为什么要做主从）—— 重点

1、做数据的热备，作为后备数据库，主数据库服务器故障后，可切换到从数据库继续工作，避免数据丢失。

2、架构的扩展。业务量越来越大，I/O访问频率过高，单机无法满足，此时做多库的存储，降低磁盘I/O访问的评率，提高单个机器的I/O性能。

3、读写分离，使数据库能支持更大的并发。在报表中尤其重要，由于部分报表sql语句非常的慢，导致锁表，影响前台服务。如果前台使用master，报表使用slave，那么报表sql将不会造成前台锁，保证了前台速度。

（1）在从服务器可以执行查询工作(即我们常说的读功能)，降低主服务器压力;（主库写，从库读，降压）

（2）在从主服务器进行备份，避免备份期间影响主服务器服务;（确保数据安全）

（3）当主服务器出现问题时，可以切换到从服务器。（提升性能）