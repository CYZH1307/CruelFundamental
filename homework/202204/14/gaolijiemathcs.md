### 讲一讲 congestion control 的方法

congestion control 拥塞控制

#### 基本思路和概念

拥塞控制目的是为了避免【发送方】的数据填满整个网络，依据网络状况，调节发送方发送数据的量。

拥塞窗口cwnd：发送发维护的一个状态变量，依据网络拥塞程度动态变化。

发送窗口swnd=min(拥塞窗口cwnd, 接收窗口rwnd)  

拥塞窗口变化的基本思路：

- 网络没有出现拥塞，cwnd增大
- 网络出现拥塞，cwnd减小

网络出现拥塞判断依据：只要【发送方】没有在规定时间内收到ACK应答报文，即发生超时重传，就会认为网络出现了拥塞情况。



#### 拥塞控制四个算法

慢启动、拥塞避免、拥塞发生(2种算法 超时重传/快速重传)，快速恢复

##### 慢启动

规则：每当发送方收到一个ACK，就会将拥塞窗口cwnd的大小加1

所以假设cwnd和发送窗口swnd一样的时候，没有网络拥塞且还没到达慢启动门限(ssthresh)出现时，呈现指数型上升：

- cwnd=1 传1个MSS大小数据
- 收到1个ACK，cwnd=cwnd+1=2，一次可以发2个
- 收到2个ACK，cwnd=cwnd+2=4， 一次可以发4个
- 收到4个ACK，cwnd=cwnd+4=8，一次可以发8个
- ...（慢启动呈现指数型上升）

慢启动上限制：【慢启动门限ssthresh】状态变量

- cwnd<ssthread 使用慢启动算法
- cwnd>=ssthread 使用拥塞避免算法

##### 拥塞避免算法

规则：当收到一个ACK以后，cwnd增加1/cwnd

例如当ssthresh=8，cwnd到达8以后，每当8个ACK到达的时候，每个确认ACK会增加1/8，8个ACK确认到达，使得cwnd一共增加1，所以下一次发送可以发送9个MSS数据，出现线性增长的规律。

##### 拥塞发生算法

当网络出现拥塞，数据包出现重传，两种重传机制：超时重传和快速重传。

（1）超时重传

规则：发生超时重传（重传计时器超时），使用拥塞发生算法

- ssthresh=cwnd/2 慢启动门限改为发送窗口的一半
- cwnd重置为1，重新开始慢启动。

特点：突然减小数据流，方式激进，容易造成卡顿。

（2）快速避免

规则：当接收方发现丢了一个中间包的时候，接收方发现出现前一个包的【三次冗余的ACK】，发送端会快速重传，不必等待超时。

TCP认为这种情况不严重，大部分没丢失：

- cwnd=cwnd/2 设置为原来一半
- ssthresh=cwnd
- 进入【快速恢复】算法



##### 快速恢复

快速重传和快速恢复一起使用。可以收到3个重复ACK，说明网络还可以。

规则：快速恢复cwnd和ssthresh已经被更新了

cwnd=cwnd/2

ssthresh=cwnd

快速恢复算法：

- 拥塞窗口 cwnd=ssthresh+3（确认有3个数据包被收到了）
- 重传丢失的数据包
- 如果再收到重复的ACK，cwnd增加1
- 如果收到信的数据ACK，cwnd为ssthresh 进入拥塞避免算法。（也是cwnd+1）

拥塞窗口改为ssthresh+3后呈现线性增长。





