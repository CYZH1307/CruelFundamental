# 隔离级别可重复读下MySQL是如何解决幻读的？

幻读：一个事务在前后两次执行相同的SQL语句可能存在不同的结果，后一次查询可能看到了前一次查询没看到的行。

Select 查询分为快照读和实时读。

- 快照读情况：MVCC并发多版本控制解决幻读问题。

（1）快照读：可重复读RR级别下，普通的select语句都是快照读，一个事务内多次执行select都是查询到事务开始前状态的数据。

（2）解决方案：快照读，每行数据保存两个隐藏列，插入数据行时版本号，删除数据行的版本号，滚动指针。事务对数据修改后保存会判断，当前版本号与事务取数据的版本号是否一致，一致保存，否则失败。插入、删除、更新、查询，通过对比版本号的情况进行判断对应的情况进行判断哪些能读，哪些不能读，并且在delete/update要写入undo log中保障回滚功能。

- 时读情况：行锁+间隙锁

（1）实时读：实时读为查询总是执行这个查询时数据库中数据。

（2）解决方案：RR级别下，InnoDB存储引擎采用Next-Key Locking机制来避免幻读问题。Next-Key Locking上锁方法，可以视作是行锁+间隙锁，实现既锁定住某条记录，同时又阻止其他事务在该记录前后的间隙插入新记录，并且为一个左开右闭的区间。
