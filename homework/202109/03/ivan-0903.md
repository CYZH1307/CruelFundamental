## 缓存问题

> https://mp.weixin.qq.com/s/RSvsxTJApxbw9PAlxMKXww

缓存的使用：先查询缓存，不命中时查数据库，用数据库的值更新缓存，然后返回。

### 缓存穿透

反复查询数据库中不存在的值，导致数据库压力过大。

#### 原因

- 业务设计不合理：如未开守护
- 操作失误：删除了缓存和数据库的数据
- 外部攻击：大量的非法请求

#### 避免方法

- 针对非法请求，在API入口进行参数校验
- 若查询数据库结果为空，则为缓存设置空值，等到有写请求时再更新缓存。同时给缓存设置过期时间
- 布隆过滤器：判断数据是否存在

### 缓存雪崩

缓存中数据过期，同时有大量查询，导致请求直接访问数据库，导致数据库压力过大。

1. 大量数据同时过期导致雪崩：均匀设置过期时间，让过期时间离散。可以使用一个较大固定值+一个较小的随机值，5小时+0到1800秒。
2. Redis故障宕机导致：构建Redis高可用集群。

### 缓存击穿

某个热点key在过期时，同时对其有大量的并发请求，导致这些请求直接访问数据库。

与雪崩的区别：可以理解为缓存击穿是雪崩的子集。

#### 解决

1. 使用互斥锁：缓存失效时，使用原子操作。
2. 不设置过期时间：热点数据过期前，异步线程对其进行更新。













