# 谈谈什么是零拷贝？



#### 1.为什么要有DMA技术？

##### 	0.什么是DMA技术：

​		DMA技术是指，在进行I/O设备和内存的数据传输的时候，数据搬运的工作全部交给DMA控制器，而CPU不再参与任何与数据搬运相关的事情，这样CPU就可以去处理别的任务。简而言之，DMA就是简单的CPU，负责从磁盘缓冲区搬运数据到用户缓冲区



##### 	1.没有DMA技术之前。

- CPU发出相应的指令给磁盘
- 磁盘控制器收到指令后，于是就开始准备数据，当数据在磁盘缓冲区准备好后，产生中断，提示CPU搬运数据
- CPU从磁盘缓冲区搬运数据到内核缓冲区，再到用户缓冲区



##### 	2.有DMA技术之后。

- CPU发出相应的指令给磁盘
- 磁盘控制器收到指令后，于是就开始准备数据，当数据在磁盘缓冲区准备好后，产生中断，提示DMA搬运数据
- **DMA从磁盘缓冲区搬运数据到内核缓冲区，此时CPU并不被会占用，CPU可以执行其他任务。当数据搬运完时，就会发送中断信号给CPU**
- cpu从内核缓冲区搬运数据到用户空间



#### 2.传统的文件传输有多糟糕

##### 	文件传输功能过程 - 将磁盘上的文件读取出来，然后通过网络协议发给客户端

- 磁盘数据 -> 磁盘缓冲区 -> 内核缓冲区  -> 用户缓冲区 -> socket缓冲区 -> 网卡



##### 3. 如何实现零拷贝

- mmap + write：即用户态只保存，内核缓冲区的映射而不真正搬运数据，再在写入socket缓冲区，最后搬运到网卡（四次上下文切换，三次CPU拷贝）

- sendfile：直接从内核缓冲区搬运到socket缓冲区，而不进入用户态，故只进行了三次数据拷贝。

  并且两次都是在DMA搬运，只有一次是在CPU搬运。

第二种方法相比，少了一次上下文的上下文切换
