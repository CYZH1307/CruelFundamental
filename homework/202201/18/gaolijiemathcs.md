# Innodb和MyISAM的区别

## Innodb与MyISAM区别

| 对比项目       | Innodb                                                       | MyISAM                                                       |
| -------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 事务           | 支持                                                         | 不支持                                                       |
| 锁             | 支持行锁、表锁。行锁基于索引，没有索引就无法使用行锁。       | 表锁                                                         |
| 主键           | 必须有，没有会默认生成一个6字节的主键。                      | 可以没有                                                     |
| 索引           | 聚簇索引(聚集索引)，使用B+树作为索引结构，数据文件与索引绑定，必须有主键。主键索引一次查询，辅助索引两次查询，先查主键，再查数据。 | 非聚集索引，使用B+树索引结构，索引与数据分离，主键索引和辅助索引独立。 |
| 外键           | 支持                                                         | 不支持                                                       |
| 表行数         | 没有保存，统计行数会扫描全表。                               | 保存，统计行数直接取。                                       |
| 全文索引       | 5.7之后支持                                                  | 支持                                                         |
| 数据库文件差异 | frm表定义文件+idb数据文件。支持共享表空间存储、多表空间存储两种存储方式。 | frm表定义文件，myd数据文件，myi索引文件。三种存储格式：静态表、动态表、压缩表。 |
| 优缺点         | 优点：支持事务、外键、并发大、适合做update、支持行锁和表锁、支持故障恢复。缺点：不适合做大量select | 优点：查询相对快、适合大量select、支持全文索引。缺点：不支持事务、外键、并发小、不适合大量update、恢复慢。 |

## Innodb

- Innodb数据存储在表空间中。
- Innodb采用MVCC来支持高并发，实现了四个隔离级别，默认级别为REPEATABLE READ，通过间隙锁(next-key locking)防止幻读。间隙锁会使得Innodb锁定查询涉及的行，还会对索引间隙进行锁定，防止幻行插入。
- Innodb基于聚簇索引建立。每张表的存储是按照主键的顺序存放，没有显式定义主键，这为每一行生成一个6字节的ROWID作为主键。
- Innodb内部做了很多优化，例如从磁盘读取数据采用可预测性预读，自动在内存中创建hash索引加速读操作的自适应哈希索引，以及加速插入操作的插入缓冲区。
- InnDB存储引擎是多线程模型，后台有多种线程处理不同人物，Master Thread主要负责讲缓冲池中的数据异步刷新到磁盘，保障数据的一致性，包括脏页刷新、合并插入缓冲、UNDO页回收。IO Thread，Innodb中有很多AIO处理写IO请求，IO Thread主要负责IO请求的回调处理，Innodb1.0之前主要有4种IO Thread write/read/insert buffer/log IO thread。Purge Thread 事务提交后，undolog可能不再使用，用Purge Thread回收已经使用并分配的undo页。Innodb1.1之前purge在Innodb的master thread完成，之后单独起线程完成。Page Cleaner Thread，将之前版本中脏页的刷新操作都放入到单独的线程中完成，减轻master线程工作，以及对用户查询线程的阻塞。
- Innodb基于磁盘存储，记录按照页管理，通常使用缓冲池技术解决CPU速度与磁盘速度之间的差距。缓冲池为一块内存区域，通过内存的速度弥补磁盘速度较慢，对数据库性能的影响。对数据库页的修改，先修改缓冲池中页，再以一定频率刷新到磁盘上。
- InnoDB关键特性：插入缓冲、两次写、自适应哈希索引、异步IO、刷新领接页。



## MyISAM

- MyISAM在5.1之前为默认存储引擎，提供了例如全文索引、压缩、空间函数等特性，但是不支持事务和行级锁，而且崩溃以后无法恢复。但对于只读的数据，或者表小、可容忍修复操作，则可以使用MyISAM。(目前默认使用Innodb)
- MyISAM会将表存储在数据文件(MYD)和索引文件(MYI)这两个文件当中。MyISAM表可以包含动态或静态行，MySQL会根据表定义来决定采用何种行格式。MyISAM中存储的记录数，取决于磁盘空间或者操作系统中单个文件的最大尺寸,默认为4GB。
- 加锁与并发：MyISAM对整张表加锁，而不是对行加锁，读取的时候会读到所有表加共享锁，写入的时候则对表加排他锁。但是在表有读查询的时候，可以往表当中插入新的记录(并发插入)。
- 修复：MyISAM表，MySQL可以手工或者自动执行检查和修复，区别于事务恢复与奔溃恢复，执行表的修复是可能导致一些数据丢失。修复操作很慢，可以CHECK TABLE mytable 检查表错误，有错误 REPAIR TABLE mytable修复。服务器已经关闭，可以通过myisamchk检查与修复。
- 索引特性：MyISAM可以基于长字段的前500个字符创建索引，MyISAM也支持全文索引，是一种基于分词创建的索引。
- 延迟更新索引键：指定了delay_key_write，则每次修改执行完成时不会立刻将修改的索引数据写入磁盘，而是会写到内存中键缓冲区，只有清理键缓冲区的时候或者关闭表才会将对应索引块写入到磁盘。可以提高写入性能，但是数据库或主机奔溃会索引损坏，需要执行修复。
- MyISAM支持压缩表，压缩表不能进行修改(除非解压，再修改，重新压缩)。压缩表支持索引，但是索引也是只读的。
- MyISAM性能，最典型问题为表锁问题。

