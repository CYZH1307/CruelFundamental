### TCP可以限速吗

可以限速。TCP头部有一个字段为Windows窗口大小。这个字段可以用于接收端告诉发送端自己还有多少缓冲区可以接受数据，发送端会根据这个接收端的接受TCP报文能力来发送数据，防止接收端处理不过来。

#### TCP滑动窗口机制

窗口大小由接收端决定，发送方的数据大小不能超过接收方的窗口大小，否则接收方无法正常接收到数据。

【发送方的滑动窗口】

```
分为四部分：ABCD
【已发送并收到ACK确认的数据范围】 A
【已发送但未收到ACK确认的数据范围】 B
【未发送但是是在接收方处理范围内的数据范围】C
【未发送但是大小超过接收方处理范围的数据】D

当发送方将全部的C【未发送但是是在接收方处理范围内的数据范围】都发送出去，可用窗口为0，在还没收到ACK确认的时候，是没有办法继续发送数据，TCP被限速。

当收到对应接收方的ACK确认应答后，如果发送窗口大小没有变化(由接收方Windows窗口大小决定)，那么滑动窗口就会移动确认接收长度字节的窗口，那么C【未发送但是是在接收方处理范围内的数据范围】相应变为新确认的ACK的长度。
```

TCP滑动窗口用三个指针来跟踪这四个传输类别中的字节，两个指针为绝对指针(指向特定的序列号)，一个是窗口大小，一个是相对指针(需要做偏移)：

- SND.WND：表示发送窗口的大小(大小由接收方指定)
- SND.UNA：绝对指针，指向已经发送但是未接收到确认的第一个字节的序列号 (B字段开头)
- SND.NXT：绝对指针，指向未发送但是可发送范围的第一个字节的序列号 (C字段开头)
- 指向字段D开头指针：需要进行运算，将SND.UNA指针 加上 SND.WND大小偏移量，就会指向D范围的开头。

可用窗口大小=SND.WND - (SND.NEXT - SND.UNA)

SND.NEXT - SND.UNA为已发送但未收到ACK的数据长度。SND.WND为窗口总大小，对减就是可用窗口的长度。



【接收方的滑动窗口】

```
分为三部分：EFG
【已经成功接收并且确认的数据(等待应用进程读取)】E
【未收到数据但是可以接受的数据范围】F
【未接收到数据并且不可以接收的数据范围】G
```

其中三个接收部分范围，使用两个指针进行划分：

- RCV.WND：接收窗口大小，会告诉发送方。
- RCV.NXT：指针指向期望从发送方发来的下一个数据字节的序列号（F范围的开头，期望接收到这个序列号的数据）
- 指向G开头是一个相对指针，为RCV.NET + RCV.WND大小的偏移量，指向G范围的第一个字节。



接收方和发送方存在时延，所以接收窗口和发送窗口只是约等于的关系。



#### 流量控制

发送方不能无脑不断发送数据给接收方，需要考虑接收方处理能力，如果接收方处理不过来，会导致触发重发机制，从而导致网络流量的浪费。

TCP提供一种让发送方和接收方的实际接收能力控制发送方的数据流，流量控制机制。

发送窗口和接收窗口都是在操作系统内存缓冲区里面，大小会被操作系统调整。如果先减少缓存，再收缩窗口会导致丢包，所以TCP规定不能同时减少缓存又收缩滑动窗口。应该先收缩窗口，过段时间再减少缓存，避免丢包情况。



#### 拥塞控制

流量控制是避免发送方将数据填满接收方的缓存，在网络出现拥堵的时候，继续发送大量数据包会导致数据包时延丢包的情况，TCP会重传，导致网络负担更重，恶性循环。

拥塞控制避免发送方的数据填满整个网络，利用拥塞窗口cwnd来进行拥塞控制。

swnd=min(cwnd,rwnd) 

发送窗口swnd的值是，拥塞窗口cwnd和接收窗口rwnd的最小值。

拥塞控制主要是四个算法：慢启动、拥塞避免、拥塞发生(超时重传【重传计时器超时 ssthreash为cwnd/2 cwnd=1】、快速重传【接收方连续收到3个相同ACK 快重传 ssthreash = cwnd/2 cwnd=cwnd/2)、快速恢复