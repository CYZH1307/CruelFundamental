# TCP 四次挥手

Reference: https://www.eet-china.com/mp/a44399.html

简述TCP四次挥手过程。

第一次挥手：客户端发起 `FIN` 包 （`FIN = 1`），客户端进入 `FIN_WAIT_1` 状态。即使 `FIN`包不懈怠数据，也要消耗一个序列号

第二次挥手：服务器收到`FIN`包，发出确认包 `ACK` （ack = u + 1），并带上自己的序号 `seq=v`，服务器进入 `CLOSE_WAIT` 状态。客户端已经没有数据发送，服务器有数据发送的话，客户端依然需要接受。客户端收到 `ACk`包后，进入 `FIN_WAIT_2` 状态。

第三次挥手：服务器数据发送完毕后，向客户端发送 `FIN`包（seq=w, ack = u+1），半连接状态下服务器可能又发送了一些数据，假设发送 seq为w，服务器进入 `LAST_ACK`状态。

第四次挥手：客户端收到服务器的 `FIN`包后，发送确认包(ack = 1, ack = w + 1)，此时客户端进入 `TIME_WAIT` 状态。此时TCP连接还没有释放。

- 客户端经过 `2*MSL`后，进入 `CLOSED` 状态。
- 服务器端收到客户端的确认包 `ACK` 后，就进入了 `CLOSED` 状态。



为什么TCP挥手需要4次？

- 因为TCP时全双工通信。主动关闭方发送`FIN`后，接收端可能还要发送数据，因此不能将服务器端的`FIN`包和对客户端的`ACK` 包合并发送。只能先发`ACK`，然后服务器待无需发送数据时再发送 `FIN`包。



为什么四次挥手释放连接时需要等待2MSL？

- `MSL`：报文在网络中最大生存时间。
- 客户端发送对服务器的`FIN`确认包`ACK` 可能没有到达服务器，若服务器没有收到`ACK`会重新发送`FIN`包。因此`2MSL`包含ACK到达服务器+服务器发送`FIN`重传包两部分时间。若`2MSL`时间后没有收到服务器端重传包`FIN`，说明可以确认服务器已经收到客户端的`ACK`包。
- 另外可以避免新旧包混淆。客户端发送完最后一个`ACK`包后，经过`2MSL`时间，可以使本连接持续的时间内所产生的所有包都从网络中消失，下一个新的连接中不会出现这种旧的连接请求报文。

