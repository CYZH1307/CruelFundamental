# 简述epoll 和 poll, select 的区别

select、poll和epoll都是Linux提供的IO多路复用的机制. IO多路复用是指系统（内核）去监听socket的IO事件, 并将活跃IO对应的fd返回, 以便进行进程之间的网络通信.

1. select
   `select`将文件描述符存入`fd_set`之中, 并利用`FD_ZERO`、`FD_SET`和`FD_ISSET`来清空、加入和判断是否发生了IO事件. 其主要有一下缺点:
   - 文件描述符的规模受限. `fd_set`用`bitmap`来存储记录fd, 存在长度受限的局限性
   - 多次拷贝. `fd_set`要在用户态和内核态之间产生拷贝开销.
   - 枚举才能确定哪些fd发生了IO事件, 效率低下.
  
2. poll
   `poll`解决了select文件描述符受限的局限性. 其采用数组来传递文件描述符, 但还是存在数据结构的拷贝和枚举才能确定IO事件的缺点.

3. epoll 
   `epoll`解决了数据结构的拷贝以及遍历才能确定IO事件的缺点. 其通过`epoll_create`创建一个`epoll`实例(红黑树 + 单链表), 通过`epoll_ctl`添加、修改和删除文件描述符以及监听的IO事件, 通过`epoll_wait`阻塞监听IO事件. 内核和用户进程共享`epoll`数据结构, 防止了频繁的拷贝造成的开销. 而且`epoll`返回的是所有激活IO的事件, 提高了效率.

   `epoll`存在水平触发和边缘触发两种模式. 水平触发是指当fd可读或可写时都会触发, 即使一次没读完或者一次没写完, 其还是接着触发. 边缘触发是指只有当从不可读变成可读, 或不可写变成可写时其才会触发, 如果一次没读完或没写完下次不会继续触发. 这要求我们必须循环读到不可再读, 循环写到不可再写. 即我们必须在边缘触发下必须使用非阻塞IO, 否则最后一次读或写会导致阻塞.



   # io 多路复用原理，在 redis 和 mysql 的实现

   IO多路复用就是内核来监听fd上的IO事件, 并通知用户进程哪些fd上发生了什么类型的IO事件, 是的一个用户线程可以处理多个IO链接, 提升效率.

   `redis`中IO不是瓶颈, 而是网络连接数. 提高网络链接数可以提升效率, 因此其采用IO多路复用.

   `mysql`中采用单线程服务一个链接的方式, 采用了阻塞IO来服务网络链接. 因为`mysql`的瓶颈主要在磁盘IO上, 而且用户SQL语句的执行包含了较为复杂的过程, 因此采用单线程阻塞IO处理一条链接的方式是`mysql`的优势选择.