# 什么是五级流水线，数据冒险是什么



多周期CPU分段，将指令细化为，取指、译码、执行、访存、写回阶段。

- 取指阶段(IF)：以程序计数器PC内容作为地址，从取指令写入IR。同时更新PC，指向下一条指令。
- 译码阶段(ID)：读寄存器周期。对指令译码，并且用IR的寄存器地址去访问通用寄存器组，读出操作数。
- 执行阶段(EX)：有效地址计算周期。计算出有效地址。load和store指令，将寄存器内容与偏移量相加。寄存器ALU指令，从寄存器读出数据进行运算。寄存器立即数，按照寄存器读出操作数和指令的立即数计算。分支指令，偏移量与PC值相加形成转移目标的地址。
- 访存地址(MEM)：该周期指令只有load、store和分支指令，其他类型指令在此周期不做操作。
- 写回周期(WB)：将结果数据写入通用寄存器组。





结构冒险，是硬件层次资源竞争，硬件不支持多条指令在同一时钟执行。五级流水，只有译码和写回有结构冒险，但明确了译码是寄存区读取操作，写回为写入操作，因此通用寄存器组读写分离即可。典例：一个存储单元被一条指令取操作数同时另外一条指令要写入结果。

数据冒险，是所需数据无法给出，导致指令不能在给定的时钟周期内执行，即某条指令引用了前一次的运算结果，但是结果还没给出：

（1）先写后读(RAW):这是真实的相关。 

（2）先读后写(WAR):反相关

（3）写后写(WAW):输出相关

控制冒险，指令流水时，处理器遇到分支指令，不能在流水开始阶段就判断出分支结果。





解决方案：

1.流水线冒泡：流水线停顿，可以同时解决3种冒险。如果指令译码时发现存在冒险，就插入NOP指令。有风险指令进入流水线，上一条指令经过了若干周期化解冒险。

2.数据冒险：

- 写后读，写指令与读指令插入流水线冒泡
- 乱序执行，寄存器重命名，保证写后读相关数据被顺序执行。
- 寄存器直通，使用流水线的最新计算结果(register forwarding)。

3.控制冒险(分支风险)

- 分支指令后插入流水线冒泡。
- 分支预测，投机执行。如果分支预测失败，则需要有能力恢复到分支指令执行完毕前的寄存器状态。

