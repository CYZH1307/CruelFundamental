# 如何保证缓存一致性?

对于缓存与数据库在使用过程中，存在的删除更新方案可能有如下两种情况：

### 1 先删缓存，再更新数据库。

（1）本方案问题：先删除缓存，数据库还没更新成功，此时读取缓存，缓存已经删除数据不存在，去数据库读取到的是旧值，而旧值又被写入了缓存，代表最近读取过，数据库存取新数据，就导致了缓存当中的数据为旧数据，而数据库中为新数据的问题。缓存不一致问题发生。

（2）解决方案：延时双删

- 基本思路：为了避免提前删除缓存，而数据库还没更新成功，导致缓存没数据，数据库仍然为旧数据的问题。现在将缓存删除的时机，放到更新完数据库之后，再sleep一段时间，才删除缓存，此次删除缓存必须要在数据库sleep之后。
- 具体步骤：（1）线程1操作更新数据库操作，缓存为旧数据需要删除数据，并且进一步要去更新数据库（2）线程2读缓存，缓存删除找不到数据，数据库中读取的是旧数据，并且需要将读取到的数据，更新到缓存当中，代表最近读过这个数据。（3）线程1，依据估算的时间，估算的时间会大于读写缓存的时间，sleep时间>线程2读旧数据+写旧数据到缓存的时间。所以缓存再次被删除，并且此次删除过后，数据库中的数据已经被更新为新数据。（4）如果其他线程来读取缓存，就会从数据库中读到更新后的新数据，并且将新数据写入缓存当中，确保了一致性。
- 分析：此处只会在短暂的一次sleep的过程中存在线程2读取的是旧数据。但是能够确保sleep后，这段时间即使再有线程来读，读到的缓存中为旧数据，但是sleep之后数据库内为新数据，在sleep结束之后，缓存删除，之后去数据库读到的都是新数据，再继续读，缓存更新的也是新数据。确保了最终的一致性。
- ![image-20220209121500730](https://raw.githubusercontent.com/gaolijiemathcs/image-hosting/master/image-20220209121500730.png)

### 2 先更新数据库，再删除缓存。

（1）本方案问题：先更新数据库，再删除缓存。当更新数据库成功，如果删除缓存失败或者还没有来得及删除没其他线程从缓存中读取到的是旧值，发生不一致。无法确保删除缓存操作成功，导致线程都继续读取缓存中的旧数据。

（2）解决方案1：引入消息队列。

- 基本思路：为了确保删除缓存的成功执行，在数据库和缓存之间加入消息队列。先更新数据库，成功以后向消息队列发送消息，缓存消费到消息后会删除缓存，借助消息队列重试机制，来保证更新数据库后缓存最终被删除。
- 基本步骤：（1）更新数据库，更新数据库成功后发送删除缓存消息到消息队列。（2）消息队列中的消息被消费后，去删除缓存。（3）通过重试机制，来确保消息被消费，即缓存成功被删除。
- 问题：（1）代码入侵无法保证高可用：引入消息中间件，问题复杂，确保消息咋传输过程中不丢失等问题更加麻烦。（2）消息延迟问题：更新数据库和删除缓存即使都没有问题，消息队列的延迟也会造成短暂的不一致性，不过相对可以接受。
- ![image-20220209121517358](https://raw.githubusercontent.com/gaolijiemathcs/image-hosting/master/image-20220209121517358.png)

（3）解决方案2：监听数据库binlog的消息队列。

注：【数据库binlog概念】数据库的binlog，为数据库Server层的日志，是所有数据库引擎都能用的，binlog会记录所有的逻辑操作，并且binlog为追加写入，不会覆盖旧日志。

- 基本思路：引入监听binlog的消息队列来做删除缓存的操作，则不用自己引入，不会入侵业务代码，中间件做了解耦，并且中间件本身保证高可用。
- 基本步骤：引入监听binlog的消息队列，对数据库的更新操作进行监听，当数据库被更新，数据库会写入操作到binlog当中，会被监听binlog消息中间件监听到对应的消息，并且消息消费的过程，会删除对应的缓存。
- 分析：（1）消息延迟的问题仍然存在。（2）如果并发不是很高，实时性和一致性可以被接收。

![image-20220209121524866](https://raw.githubusercontent.com/gaolijiemathcs/image-hosting/master/image-20220209121524866.png)

### 3 缓存设置过期时间

（1）基本思路：每次放入缓存的时候，都设置一个过期时间，例如5分钟，以后的操作只修改数据库，不操作缓存，等等缓存超时以后自动删除，再有读取从数据库中获取，并且更新缓存。

（2）分析：

- 对于一致性要求不高的情况，可以用本方案。
- 如果数据更新频繁，不一致性问题很大。



### 4 思考：为什么每次都是删除缓存，而不是更新缓存？

主要是为了避免额外频繁操作缓存。

对比：【更新数据库，删除缓存】与【更新数据库，更新缓存】

【更新数据库，更新缓存】数据库1小时更新1000次，缓存也更新1000次，但是缓存可能一小时只被读取了1次，则额外1000次更新缓存没有意义。

【更新数据库，删除缓存】数据库1小时1000次更新，缓存被删除1次。只有真正访问了数据，缓存不存在去数据库读取，这个时候才从数据库读取更新缓存。

这里要权衡的是，1000次缓存更新与我们缓存删除后去数据库读取更新1次缓存之间的时间关系。

没有采取同步更新缓存的情况，就是避免频繁操作数据不一致，同时时间上的问题。



### 5 小结：

- 缓存是删除不是更新
- 删除缓存两种方式
  - 先删缓存，再更新数据库。解决方案：延迟双删。确保最终一致性。
  - 先更新数据库，再删缓存。消息队列，binlog消息队列同步，不推荐直接使用。
- 缓存一致性要求不高，缓存设置超时时间。



ref https://mp.weixin.qq.com/s/dYvM8_6SQnYRB6KjPsprbw

