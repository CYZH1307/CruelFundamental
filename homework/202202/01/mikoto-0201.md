### Redis持久化机制
Redis数据平时储存在内存中，属于易失性存储器，因此需要一种持久化方式将其存储到磁盘中，Redis共有两种持久化方式：RDB和AOF，其中RDB是存储快照，属于一次性全量备份，而AOF属于是增量式备份。

- 快照（RDB）
Redis使用操作系统的多进程COW（copy on write）机制实现快照持久化。由于持久化过程中，还需要满足Redis的正常使用，因此Rdedis持久化过程中会调用fork函数产生一个子进程，子进程负责持久化的过程，主进程继续负责提供服务。
通过fork函数创建子进程后，父子进程共享数据，父子进程分别负责提供服务和持久化，过程中父进程写脏的数据会逐渐和子进程分离开。
持久化的内存策略：子进程按照内存页进行复制，通过小数据量数据页的复制（通常4KB）的方式，子进程存储原数据页，父进程对复制出来的数据页进行操作，通过这样的策略，确保RDB快照存储的数据是子进程产生瞬间的数据备份。

快照存储方式可以通过自动触发和手动触发两种：
自动触发 是通过redis.config配置文件规则进行自动配置
手动触发 是通过执行命令手动保存，分为两种：
- save：阻塞式触发，未完成前，客户端无法进行命令操作
- bfsave：非阻塞式触发，主进程fork出子进程进行持久化操作

RDB存储的优点：
- 优点：
	1. 数据结构紧凑，适合作为备份和灾难恢复
	2. RDB快照持久化时，主进程fork出子进程进行备份，主进程无需额外的IO操作
	3. RDB恢复大数据时，速度比较快
- 缺点：
	1. 可能存在兼容性问题，老版RDB无法兼容新版
	2. 无法实时持久化，因为RDB备份消耗较大

- AOF
AOF日志存储的是Redis指令序列，只记录对内存进行修改的指令记录。AOF使用追加记录的方式，在Redis运行过程中，AOF记录会一直变长，因此可以对AOF记录进行重写，即fork一个子进程按照AOF存储的序列对数据进行操作，操作完毕后存储一个新的文件。AOF重写分为两个过程，一个子进程重写原始数据内容，另外就是在fork过程中主进程进行修改的指令。

AOF持久化有三种持久化策略：
1. no： 无fsync，由系统保证刷新到磁盘，速度很快，但是不安全（通常也不用）
2. always：每次都fsync，每一次修改内存的Redis指令都会执行一次fsync，速度慢（通常也不用）
3. everysec：每秒进行一次fsync，可能回丢失一秒的修改数据，综合来说，兼顾了安全和效率，通常采用的是everysec策略。
